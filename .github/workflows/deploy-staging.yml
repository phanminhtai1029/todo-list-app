# GitHub Actions - Deploy to Staging
name: Deploy to Staging

on:
  push:
    branches: [ main, staging ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  test:
    uses: ./.github/workflows/backend-tests.yml
  
  test-frontend:
    uses: ./.github/workflows/frontend-tests.yml

  deploy:
    needs: [test, test-frontend]
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub (optional)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        continue-on-error: true

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false  # Set to true if using container registry
          tags: todo-backend:staging
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false  # Set to true if using container registry
          tags: todo-frontend:staging
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to staging server
        run: |
          echo "Deploying to staging server..."
          # Add your deployment commands here
          # Examples:
          # - SSH to staging server
          # - Pull latest images
          # - Run docker-compose -f docker-compose.staging.yml up -d
          # - Run database migrations
          # - Health check
          
      # Example: SSH deployment (uncomment and configure)
      # - name: Deploy via SSH
      #   uses: appleboy/ssh-action@v1.0.0
      #   with:
      #     host: ${{ secrets.STAGING_HOST }}
      #     username: ${{ secrets.STAGING_USER }}
      #     key: ${{ secrets.STAGING_SSH_KEY }}
      #     script: |
      #       cd /path/to/app
      #       git pull origin main
      #       docker-compose -f docker-compose.staging.yml pull
      #       docker-compose -f docker-compose.staging.yml up -d
      #       docker-compose -f docker-compose.staging.yml exec -T backend python scripts/migrate.py

      - name: Run health check
        run: |
          echo "Running health checks..."
          # Add health check commands
          # curl -f https://staging.yourapp.com/health || exit 1

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Staging deployment successful!"
          else
            echo "❌ Staging deployment failed!"
          fi
